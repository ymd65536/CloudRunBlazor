@page "/chateval"
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@implements IDisposable
@using Microsoft.AspNetCore.Components.Web

<PageTitle>Chat Eval</PageTitle>

<div id="chat-container" class="chat-container">
    @foreach (var message in messages)
    {
        var messageClass = message.User == "You"
            ? "sent"
            : (message.User == "evaluator" ? "received evaluator"
                : (message.User == "System" ? "received system" : "received assistant"));
        var textClass = message.User == "evaluator" ? "chat-text eval" : "chat-text";
        <div class="chat-message @messageClass">
            <div class="message-content">
                @if (message.User != "You")
                {
                    <div class="chat-user">@message.User</div>
                }
                <div class="@textClass">@message.Text</div>
            </div>
        </div>
    }
    @if (isProcessing)
    {
        <div class="chat-message received">
            <div class="message-content">
                <div class="chat-user">@(!isEvaluating ? "Assistant" : "evaluator")</div>
                <div class="chat-text">@(!isEvaluating ? "å…¥åŠ›ä¸­..." : "è©•ä¾¡ä¸­...")</div>
            </div>
        </div>
    }
</div>

<div class="chat-input">
    <input @ref="inputElement"
           @bind="newMessage" 
           @bind:event="oninput" 
           id="chat-input-field"
           placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›..." 
           disabled="@isProcessing" />
    <button @onclick="SendMessage" disabled="@isProcessing">Send</button>
</div>

<script>
    window.setupChatInput = function(dotNetHelper) {
        const inputElement = document.getElementById('chat-input-field');
        if (!inputElement) return;
        
        let isComposing = false;
        
        inputElement.addEventListener('compositionstart', function() {
            isComposing = true;
        });
        
        inputElement.addEventListener('compositionend', function() {
            isComposing = false;
        });
        
        inputElement.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !isComposing) {
                e.preventDefault();
                dotNetHelper.invokeMethodAsync('SendMessageFromJS');
            }
        });
    };
</script>

@code {
    @using Azure.AI.OpenAI;
    @using Azure.Identity;
    @using Microsoft.Agents.AI;
    @using Microsoft.Extensions.AI;
    @using Microsoft.Extensions.AI.Evaluation;
    @using Microsoft.Extensions.Configuration;
    @using Microsoft.Extensions.AI.Evaluation.Quality;
    @using Microsoft.Extensions.AI.Evaluation.Reporting;
    @using Microsoft.Extensions.AI.Evaluation.Reporting.Storage;
    @using OpenAI;

    private List<Message> messages = new List<Message>();
    private string newMessage = string.Empty;
    private bool isProcessing = false;
    private bool isEvaluating = false;
    private ElementReference inputElement;
    private DotNetObjectReference<ChatEval>? dotNetHelper;
    private const string EvaluationSystemPrompt = "You are a helpful assistant for evaluation. Always respond in Japanese.";

    private string endpoint = Environment.GetEnvironmentVariable("AZURE_OPENAI_ENDPOINT")
        ?? throw new InvalidOperationException("Environment variable 'AZURE_OPENAI_ENDPOINT' is not set.");

    private string deploymentName = Environment.GetEnvironmentVariable("AZURE_OPENAI_DEPLOYMENT_NAME")
        ?? throw new InvalidOperationException("Environment variable 'AZURE_OPENAI_DEPLOYMENT_NAME' is not set.");

    private string summary = "";
    protected override void OnInitialized()
    {
        messages.Add(new Message { User = "Assistant", Text = "è©•ä¾¡ç”¨ãƒãƒ£ãƒƒãƒˆã¸ã‚ˆã†ã“ãã€‚ãƒ†ã‚­ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦é€ä¿¡ã—ã¦ãã ã•ã„ã€‚" });
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            dotNetHelper = DotNetObjectReference.Create(this);
            await JSRuntime.InvokeVoidAsync("setupChatInput", dotNetHelper);
            await ScrollToBottom();
        }
    }

    private async Task SendMessage()
    {
        if (!string.IsNullOrWhiteSpace(newMessage) && !isProcessing)
        {
            var messageToSend = newMessage;
            newMessage = string.Empty; // Clear the input field immediately

            // Add user message
            messages.Add(new Message { User = "You", Text = messageToSend });

            // Set processing state and update UI
            isProcessing = true;
            StateHasChanged();

            // Give the DOM a moment to update before scrolling
            await Task.Delay(50);
            await ScrollToBottom();

            // Get AI response
            try
            {
                var aiResponse = await GetAIResponse(messageToSend);
                messages.Add(new Message { User = "Assistant", Text = aiResponse });

                // Assistant å¿œç­”ã‚’ä¸€æ—¦è¡¨ç¤ºã—ã¦ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                StateHasChanged();
                await Task.Delay(50);
                await ScrollToBottom();

                // Evaluate the assistant response and show the result in Japanese
                try
                {
                    isEvaluating = true;
                    StateHasChanged();
                    var evalSummary = await EvaluateResponse(EvaluationSystemPrompt, messageToSend, aiResponse);
                    messages.Add(new Message { User = "evaluator", Text = evalSummary });
                }
                catch (Exception evalEx)
                {
                    messages.Add(new Message { User = "System", Text = $"è©•ä¾¡æ™‚ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {evalEx.Message}" });
                }
            }
            catch (Exception ex)
            {
                messages.Add(new Message { User = "System", Text = $"ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {ex.Message}" });
            }
            finally
            {
                isEvaluating = false;
                isProcessing = false;
                StateHasChanged(); // Important: Update UI to re-enable input
                await Task.Delay(50);
                await ScrollToBottom();
            }
        }
    }

    private async Task<string> GetAIResponse(string userMessage)
    {
        try
        {
            AIAgent agent = new AzureOpenAIClient(
                new Uri(endpoint),
                new DefaultAzureCredential())
                    .GetChatClient(deploymentName)
                    .CreateAIAgent(instructions: EvaluationSystemPrompt, name: "ChatEvalAssistant");

            ChatMessage systemMessage = new ChatMessage(
                ChatRole.System,
                EvaluationSystemPrompt);
            ChatMessage userChatMessage = new ChatMessage(ChatRole.User, userMessage);
            AgentRunResponse? result = await agent.RunAsync([systemMessage, userChatMessage]);

            return result?.ToString() ?? "å¿œç­”ãŒã‚ã‚Šã¾ã›ã‚“";
        }
        catch (Exception ex)
        {
            return $"ã‚¨ãƒ©ãƒ¼: {ex.Message}";
        }
    }

    private async Task<string> EvaluateResponse(string chatSystemMessage, string userMessage, string aiResponse)
    {
        // æ¯å›æ–°ã—ã„è¦ç´„ã‚’ä½œæˆ
        summary = string.Empty;

        IEvaluator[] evaluators = [
            new CoherenceEvaluator(),
            new FluencyEvaluator(),
            new RelevanceEvaluator(),
        ];

        AzureOpenAIClient chatClient =
            new(
                new Uri(endpoint),
                new DefaultAzureCredential(new DefaultAzureCredentialOptions()));

        IChatClient client = chatClient.GetChatClient(deploymentName: deploymentName).AsIChatClient();

        var chatConfig = new ChatConfiguration(client);

        // ãƒ‡ã‚£ã‚¹ã‚¯ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã™ã‚‹ ReportingConfiguration ã‚’ä½œæˆ
        var reportingConfiguration = DiskBasedReportingConfiguration.Create(
            // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿å­˜ã™ã‚‹ãƒ«ãƒ¼ãƒˆãƒ‘ã‚¹
            storageRootPath: "./reports",
            // è©•ä¾¡å™¨ã®è¨­å®š
            evaluators,
            chatConfig
            );

        // ReportingConfiguration ã‚’ä½¿ã£ã¦ ScenarioRun ã‚’ä½œæˆ (ScenarioRun ã‚’ä½¿ã£ã¦å®Ÿéš›ã®è©•ä¾¡ã‚’è¡Œã†ï¼‰
        ScenarioRun scenario = await reportingConfiguration.CreateScenarioRunAsync("QualityEvaluators");
        // ã‚¤ãƒ³ãƒ—ãƒƒãƒˆã«å¯¾ã—ã¦ã€çµæœãŒã¡ã‚ƒã‚“ã¨ã—ã¦ã„ã‚‹ã‹ã‚’è©•ä¾¡
        EvaluationResult evaluationResult = await scenario.EvaluateAsync(
            // ãƒãƒ£ãƒƒãƒˆã®ã‚¤ãƒ³ãƒ—ãƒƒãƒˆ
            [
                new ChatMessage(ChatRole.System, chatSystemMessage),
                new ChatMessage(ChatRole.User, userMessage),
            ],
            // çµæœ
            new ChatResponse(new ChatMessage(ChatRole.Assistant, aiResponse))
        );
        
        // è©•ä¾¡ã‚µãƒãƒªãƒ¼ã®ãƒ˜ãƒƒãƒ€ãƒ¼
        summary = "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        summary += "ğŸ“Š å“è³ªè©•ä¾¡ãƒ¬ãƒãƒ¼ãƒˆ\n";
        summary += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n";
        
        int metricNumber = 1;
        foreach (var metric in evaluationResult.Metrics)
        {
            // EvaluationMetric ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’ç¢ºèª
            if (metric.Value is EvaluationMetric evalMetric)
            {
                summary += $"\nâ—† è©•ä¾¡é …ç›® {metricNumber}: {evalMetric.Name ?? metric.Key}\n";
                summary += new string('â”€', 40) + "\n";
                
                if (evalMetric.Interpretation != null)
                {
                    summary += $"â–¸ è©•ä¾¡çµæœ\n  {evalMetric.Interpretation}\n\n";
                }
                
                if (!string.IsNullOrWhiteSpace(evalMetric.Reason))
                {
                    summary += $"â–¸ ç†ç”±\n  {evalMetric.Reason}\n\n";
                }
                
                if (evalMetric.Context != null && evalMetric.Context.Count > 0)
                {
                    summary += $"â–¸ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ\n";
                    foreach (var ctx in evalMetric.Context)
                    {
                        summary += $"  â€¢ {ctx.Key}: {ctx.Value}\n";
                    }
                    summary += "\n";
                }
                
                // Diagnostics ã®è©³ç´°ã‚’ç¢ºèª
                if (evalMetric.Diagnostics != null && evalMetric.Diagnostics.Count > 0)
                {
                    summary += $"â–¸ è¨ºæ–­æƒ…å ± ({evalMetric.Diagnostics.Count}ä»¶)\n";
                    foreach (var diagnostic in evalMetric.Diagnostics)
                    {
                        summary += $"  â€¢ {diagnostic.Message} [é‡è¦åº¦: {diagnostic.Severity}]\n";
                    }
                    summary += "\n";
                }
                
                // Metadata ã®ç¢ºèª
                if (evalMetric.Metadata != null && evalMetric.Metadata.Count > 0)
                {
                    summary += $"â–¸ è©³ç´°æƒ…å ± ({evalMetric.Metadata.Count}é …ç›®)\n";
                    foreach (var meta in evalMetric.Metadata)
                    {
                        summary += $"  â€¢ {meta.Key}: {meta.Value}\n";
                    }
                    summary += "\n";
                }
                
                metricNumber++;
            }
        }
        
        summary += "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”";

        // ç¿»è¨³ã—ã¦æ—¥æœ¬èªã§è¿”ã™ï¼ˆãƒ©ãƒ™ãƒ«ã¯æ—¥æœ¬èªåŒ–æ¸ˆã¿ã ãŒã€æœ¬ä½“ãŒè‹±èªã®å ´åˆã«å‚™ãˆã‚‹ï¼‰
        try
        {
            var translated = await TranslateToJapanese(summary);
            var finalText = string.IsNullOrWhiteSpace(translated) ? summary : translated;
            return finalText.Trim();
        }
        catch
        {
            return summary.Trim();
        }
    }

    private async Task<string> TranslateToJapanese(string text)
    {
        if (string.IsNullOrWhiteSpace(text)) return text;

        try
        {
            var client = new AzureOpenAIClient(new Uri(endpoint), new DefaultAzureCredential());
            var agent = client
                .GetChatClient(deploymentName)
                .CreateAIAgent(
                    instructions: "You are a professional Japanese translator. Translate the user's content into natural Japanese. Preserve line breaks, indentation, and list markers. Output only the translation.",
                    name: "Translator");

            var system = new ChatMessage(ChatRole.System, "You translate any text into natural Japanese. Keep formatting.");
            var user = new ChatMessage(ChatRole.User, text);
            var result = await agent.RunAsync([system, user]);
            return result?.ToString() ?? text;
        }
        catch
        {
            return text;
        }
    }

    [JSInvokable]
    public async Task SendMessageFromJS()
    {
        await SendMessage();
    }

    public void Dispose()
    {
        dotNetHelper?.Dispose();
    }

    private async Task ScrollToBottom()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("eval", "var el = document.getElementById('chat-container'); if(el) { el.scrollTop = el.scrollHeight; }");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error scrolling to bottom: {ex.Message}");
        }
    }

    private class Message
    {
        public string User { get; set; } = string.Empty;
        public string Text { get; set; } = string.Empty;
    }
}